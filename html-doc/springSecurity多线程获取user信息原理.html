<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>1. 前言</title><link href='https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; bottom: 0px; top: 0px; left: 0px; right: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 40px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 2; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px !important; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-diagram-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  html.blink-to-pdf { font-size: 13px; }
  .typora-export #write { padding-left: 32px; padding-right: 32px; padding-bottom: 0px; break-after: avoid; }
  .typora-export #write::after { height: 0px; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.8; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.md-inline-math .MathJax_SVG .noError { display: none !important; }
.html-for-mac .inline-math-svg .MathJax_SVG { vertical-align: 0.2px; }
.md-math-block .MathJax_SVG_Display { text-align: center; margin: 0px; position: relative; text-indent: 0px; max-width: none; max-height: none; min-height: 0px; min-width: 100%; width: auto; overflow-y: hidden; display: block !important; }
.MathJax_SVG_Display, .md-inline-math .MathJax_SVG_Display { width: auto; margin: inherit; display: inline-block !important; }
.MathJax_SVG .MJX-monospace { font-family: var(--monospace); }
.MathJax_SVG .MJX-sans-serif { font-family: sans-serif; }
.MathJax_SVG { display: inline; font-style: normal; font-weight: 400; line-height: normal; zoom: 90%; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; }
.MathJax_SVG * { transition: none 0s ease 0s; }
.MathJax_SVG_Display svg { vertical-align: middle !important; margin-bottom: 0px !important; margin-top: 0px !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
svg[id^="mermaidChart"] { line-height: 1em; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
mark .md-meta { color: rgb(0, 0, 0); opacity: 0.3 !important; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 30px; z-index: 3; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; left: 0px; right: 0px; top: 0px; bottom: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

html {
    font-size: 16px;
}

body {
    font-family: "Open Sans","Clear Sans","Helvetica Neue",Helvetica,Arial,sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}
#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    padding-bottom: .3em;
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
   padding-bottom: .3em;
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}
h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border-top: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table tr th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table tr td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}
table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    table,
    pre {
        page-break-inside: avoid;
    }
    pre {
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.md-lang {
    color: #b4654d;
}

.html-for-mac .context-menu {
    --item-hover-bg-color: #E6F0FE;
}

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}


</style>
</head>
<body class='typora-export os-windows' >
<div  id='write'  class = 'is-node'><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n355"><a class="md-toc-inner" href="#1-前言">1. 前言</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n17"><a class="md-toc-inner" href="#2-过滤器链">2. 过滤器链</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n361"><a class="md-toc-inner" href="#3-threadlocal">3. ThreadLocal</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n77"><a class="md-toc-inner" href="#4-securitycontextpersistencefilter">4. SecurityContextPersistenceFilter</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n83"><a class="md-toc-inner" href="#securitycontextrepository">SecurityContextRepository</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n92"><a class="md-toc-inner" href="#securitycontextholder">SecurityContextHolder</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n102"><a class="md-toc-inner" href="#5-总结">5. 总结</a></span></p></div><h2><a name="1-前言" class="md-header-anchor"></a><span>1. 前言</span></h2><p><span>在使用spring security开发的过程中，获取当前登录用户时常常会用到这样的写法：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">UserDetails</span> <span class="cm-variable">userDetails</span> <span class="cm-operator">=</span> (<span class="cm-variable">UserDetails</span>) <span class="cm-variable">SecurityContextHolder</span>.<span class="cm-variable">getContext</span>().<span class="cm-variable">getAuthentication</span>();</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 46px;"></div><div class="CodeMirror-gutters" style="display: none; height: 46px;"></div></div></div></pre><p><span>在多线程环境下，也总是能拿到想要的结果。好奇spring security是如何做到的，通过源码分析下</span></p><h2><a name="2-过滤器链" class="md-header-anchor"></a><span>2. 过滤器链</span></h2><p><span>之前对spring security的过滤器链有一个大概的认识，在配置web.xml时，我们如果要使用spring security需要在web.xml中写入这样一段：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="xml"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="xml"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">filter</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">filter-name</span><span class="cm-tag cm-bracket">&gt;</span>springSecurityFilterChain<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">filter-name</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">filter-class</span><span class="cm-tag cm-bracket">&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">filter-class</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">filter</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">filter-mapping</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">filter-name</span><span class="cm-tag cm-bracket">&gt;</span>springSecurityFilterChain<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">filter-name</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-tag cm-bracket">&lt;</span><span class="cm-tag">url-pattern</span><span class="cm-tag cm-bracket">&gt;</span>/*<span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">url-pattern</span><span class="cm-tag cm-bracket">&gt;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tag cm-bracket">&lt;/</span><span class="cm-tag">filter-mapping</span><span class="cm-tag cm-bracket">&gt;</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 160px;"></div><div class="CodeMirror-gutters" style="display: none; height: 160px;"></div></div></div></pre><p><span>这个意味着向</span><code>tomcat</code><span>容器注册一个</span><code>Filter</code><span>，它会过滤</span><code>/*</code><span>所有的请求。</span><code>DelegatingFilterProxy</code><span>是一个代理类，真正的过滤操作是由</span><code>FilterChainProxy</code><span>来中的内部类</span><code>VirtualFilterChain</code><span>来完成的。其中注册了一定数量的</span><code>Filter</code><span>（默认是12个），来达到对请求的权限管理操作。具体代码：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre>x</pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">doFilter</span>(<span class="cm-variable">ServletRequest</span> <span class="cm-variable">request</span>, <span class="cm-variable">ServletResponse</span> <span class="cm-variable">response</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">throws</span> <span class="cm-variable">IOException</span>, <span class="cm-variable">ServletException</span> {</span></pre><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//如果每个过滤器都已通过，会转回tomcat中ApplicationFilterChain</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">currentPosition</span> <span class="cm-operator">==</span> <span class="cm-variable">size</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">logger</span>.<span class="cm-variable">isDebugEnabled</span>()) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">logger</span>.<span class="cm-variable">debug</span>(<span class="cm-variable">UrlUtils</span>.<span class="cm-variable">buildRequestUrl</span>(<span class="cm-variable">firewalledRequest</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-operator">+</span> <span class="cm-string">" reached end of additional filter chain; proceeding with original chain"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">// Deactivate path stripping as we exit the security filter chain</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">this</span>.<span class="cm-variable">firewalledRequest</span>.<span class="cm-variable">reset</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">originalChain</span>.<span class="cm-variable">doFilter</span>(<span class="cm-variable">request</span>, <span class="cm-variable">response</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">else</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//按顺序取出过滤器 &nbsp; </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">currentPosition</span><span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">Filter</span> <span class="cm-variable">nextFilter</span> <span class="cm-operator">=</span> <span class="cm-variable">additionalFilters</span>.<span class="cm-variable">get</span>(<span class="cm-variable">currentPosition</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">logger</span>.<span class="cm-variable">isDebugEnabled</span>()) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">logger</span>.<span class="cm-variable">debug</span>(<span class="cm-variable">UrlUtils</span>.<span class="cm-variable">buildRequestUrl</span>(<span class="cm-variable">firewalledRequest</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-operator">+</span> <span class="cm-string">" at position "</span> <span class="cm-operator">+</span> <span class="cm-variable">currentPosition</span> <span class="cm-operator">+</span> <span class="cm-string">" of "</span> <span class="cm-operator">+</span> <span class="cm-variable">size</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-operator">+</span> <span class="cm-string">" in additional filter chain; firing Filter: '"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-operator">+</span> <span class="cm-variable">nextFilter</span>.<span class="cm-variable">getClass</span>().<span class="cm-variable">getSimpleName</span>() <span class="cm-operator">+</span> <span class="cm-string">"'"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">nextFilter</span>.<span class="cm-variable">doFilter</span>(<span class="cm-variable">request</span>, <span class="cm-variable">response</span>, <span class="cm-keyword">this</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 713px;"></div><div class="CodeMirror-gutters" style="display: none; height: 713px;"></div></div></div></pre><p><span>默认12个</span><code>Filter</code><span>如下：</span></p><ul><li><code>WebAsyncManagerIntegrationFilter</code><span>：提供了对</span><code>securityContext</code><span>和</span><code>WebAsyncManager</code><span>的集成，其会把</span><code>SecurityContext</code><span>设置到异步线程中，使其也能获取到用户上下文认证信息</span></li></ul><ul><li><code>SecurityContextPersistenceFilter</code><span>：会根据策略获取一个</span><code>SecurityContext</code><span>放到</span><code>SecurityContextHolder</code><span>中，并且在请求结束后清空</span></li></ul><ul><li><code>HeaderWriterFilter</code><span>：会往该请求的</span><code>Header</code><span>中添加相应的信息，在</span><code>http</code><span>标签内部使用</span><code>security:headers</code><span>来控制</span></li></ul><ul><li><code>LogoutFilter</code><span>：匹配</span><code>URL</code><span>，默认为</span><code>/logout</code><span>，匹配成功后则用户退出，清除认证信息，如果有自己的退出逻辑，这个过滤器可以</span><code>disable</code></li></ul><ul><li><code>UsernamePasswordAuthenticationFilter</code><span>：登录认证过滤器，根据用户名密码进行认证</span></li></ul><ul><li><code>ConcurrentSessionFilter</code><span>：</span><code>session</code><span>同步过滤器，主要有两个功能，一是会刷新当前</span><code>session</code><span>的最后访问时间，二是判断当前</span><code>session</code><span>是否失效，失效了的话会做退出操作并触发相应事件。</span></li></ul><ul><li><code>RequestCacheAwareFilter</code><span>：重新恢复被打断的请求</span></li></ul><ul><li><code>SecurityContextHolderAwareRequestFilter</code><span>：将</span><code>request</code><span>包装成</span><code>HttpServletRequest</code></li></ul><ul><li><code>AnonymousAuthenticationFilter</code><span>：判断</span><code>SecurityContext</code><span>中是否有一个</span><code>Authentication</code><span>对象，如果没有创建一个新的（</span><code>AnonymousAuthenticationToken</code><span>）</span></li></ul><ul><li><code>SessionManagementFilter</code><span>：检查</span><code>session</code><span>在</span><code>spring security</code><span>中是否是失效了（注意不是在</span><code>web</code><span>容器中），比如说配置设置了最大</span><code>session</code><span>数量为1，那么之前的</span><code>session</code><span>会被设置</span><code>expired = true</code></li></ul><ul><li><code>ExceptionTranslationFilter</code><span>：处理</span><code>AccessDeniedException</code><span>和</span><code>AuthenticationException</code><span>，为</span><code>java exceptions</code><span>和</span><code>HTTP responses</code><span>提供了桥梁</span></li></ul><ul><li><code>FilterSecurityInterceptor</code><span>：对</span><code>http</code><span>资源做权限拦截，我们平时设置的不同角色不同权限访问就是借此</span><code>Filter</code><span>过滤</span></li></ul><h2><a name="3-threadlocal" class="md-header-anchor"></a><span>3. ThreadLocal</span></h2><p><span>在进入</span><code>SecurityContextPersistenceFilter</code><span>之前，先再熟悉下</span><code>ThreadLocal</code><span>这个类，</span><code>spring</code><span>中许多地方都用到了</span><code>ThreadLocal</code></p><p><span>先看一下它的百科：</span></p><blockquote><p><span>JDK 1.2的版本中就提供java.lang.ThreadLocal，ThreadLocal为解决多线程程序的并发问题提供了一种新的思路。使用这个工具类可以很简洁地编写出优美的多线程程序，ThreadLocal并不是一个Thread，而是Thread的局部变量。</span></p></blockquote><p><span>其中说的很清楚，</span><code>ThreadLocal</code><span>并不是一个</span><code>Thread</code><span>，而是</span><code>Thread</code><span>的局部变量，我想这也是大部分人将其翻译为“本地线程变量”的原因。</span></p><p><span>它的数据结构：</span></p><p><span>每个</span><code>Thread</code><span>会维护一个本地变量</span><code>ThreadLocalMap</code><span>，它是</span><code>HashMap</code><span>的另一种实现，key是</span><code>ThreadLocal</code><span>变量本身，</span><code>value</code><span>是要存储的值。</span><code>ThreadLocal</code><span>本事并不存储任何值，它只是充当了</span><code>key</code><span>的作用。如下图：</span></p><p><span class='md-image'><img alt='threadLocal' src='data:image/png;base64,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' referrerPolicy='no-referrer'></img></span></p><h2><a name="4-securitycontextpersistencefilter" class="md-header-anchor"></a><span>4. SecurityContextPersistenceFilter</span></h2><p><span>最关键的步骤就是</span><code>SecurityContextPersistenceFilter</code><span>这个过滤器了。其中关键的两个类：</span></p><h3><a name="securitycontextrepository" class="md-header-anchor"></a><span>SecurityContextRepository</span></h3><p><span>顾名思义，是存储</span><code>SecurityContext</code><span>的仓库，默认实现是</span><code>HttpSessionSecurityContextRepository</code><span>，基于</span><code>session</code><span>，将</span><code>SecurityContex</code><span>t用key=&quot;SPRING_SECURITY_CONTEXT&quot;存入</span><code>session</code><span>中。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">Object</span> <span class="cm-variable">contextFromSession</span> <span class="cm-operator">=</span> <span class="cm-variable">httpSession</span>.<span class="cm-variable">getAttribute</span>(<span class="cm-variable">springSecurityContextKey</span>);</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 20px;"></div><div class="CodeMirror-gutters" style="display: none; height: 20px;"></div></div></div></pre><h3><a name="securitycontextholder" class="md-header-anchor"></a><span>SecurityContextHolder</span></h3><p><span>在请求之间保存</span><code>SecurityContext</code><span>，提供了一系列的静态方法。使用了策略设计模式，默认使用的策略是</span><code>ThreadLocalSecurityContextHolderStrategy</code><span>，这其中便是使用</span><code>ThreadLocal</code><span>进行存储的。</span></p><p><span>该过滤器会先从</span><code>SecurityContextRepository</code><span>中获取</span><code>SecurityContext</code><span>，将其设置到</span><code>SecurityContextHolder</code><span>中，之后会转到下一个过滤器。在请求结束之后，清空</span><code>SecurityContextHolder</code><span>，并将请求后的</span><code>SecurityContext</code><span>在保存到</span><code>SecurityContextRepository</code><span>中。 对应源码：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">doFilter</span>(<span class="cm-variable">ServletRequest</span> <span class="cm-variable">req</span>, <span class="cm-variable">ServletResponse</span> <span class="cm-variable">res</span>, <span class="cm-variable">FilterChain</span> <span class="cm-variable">chain</span>)</span></pre></div><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">throws</span> <span class="cm-variable">IOException</span>, <span class="cm-variable">ServletException</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">HttpServletRequest</span> <span class="cm-variable">request</span> <span class="cm-operator">=</span> (<span class="cm-variable">HttpServletRequest</span>) <span class="cm-variable">req</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">HttpServletResponse</span> <span class="cm-variable">response</span> <span class="cm-operator">=</span> (<span class="cm-variable">HttpServletResponse</span>) <span class="cm-variable">res</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//省略若干语句...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">HttpRequestResponseHolder</span> <span class="cm-variable">holder</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">HttpRequestResponseHolder</span>(<span class="cm-variable">request</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">response</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">//从session中根据key取出SecurityContext，如果没有会创建一个新的</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">SecurityContext</span> <span class="cm-variable">contextBeforeChainExecution</span> <span class="cm-operator">=</span> <span class="cm-variable">repo</span>.<span class="cm-variable">loadContext</span>(<span class="cm-variable">holder</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//设置到ThreadLoacal中</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">SecurityContextHolder</span>.<span class="cm-variable">setContext</span>(<span class="cm-variable">contextBeforeChainExecution</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">chain</span>.<span class="cm-variable">doFilter</span>(<span class="cm-variable">holder</span>.<span class="cm-variable">getRequest</span>(), <span class="cm-variable">holder</span>.<span class="cm-variable">getResponse</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">finally</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">SecurityContext</span> <span class="cm-variable">contextAfterChainExecution</span> <span class="cm-operator">=</span> <span class="cm-variable">SecurityContextHolder</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>.<span class="cm-variable">getContext</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">// Crucial removal of SecurityContextHolder contents - do this before anything</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-comment">// else.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">SecurityContextHolder</span>.<span class="cm-variable">clearContext</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">repo</span>.<span class="cm-variable">saveContext</span>(<span class="cm-variable">contextAfterChainExecution</span>, <span class="cm-variable">holder</span>.<span class="cm-variable">getRequest</span>(),</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">holder</span>.<span class="cm-variable">getResponse</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">request</span>.<span class="cm-variable">removeAttribute</span>(<span class="cm-variable">FILTER_APPLIED</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-keyword">if</span> (<span class="cm-variable">debug</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-variable">logger</span>.<span class="cm-variable">debug</span>(<span class="cm-string">"SecurityContextHolder now cleared, as request processing completed"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">    </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 805px;"></div><div class="CodeMirror-gutters" style="display: none; height: 805px;"></div></div></div></pre><p><span>注意：这个</span><code>finally</code><span>语句块是在</span><code>reques</code><span>t经过</span><code>Filter</code><span>，到达</span><code>DispatcherServlet</code><span>完成业务处理之后才会运行的。所以我们可以在</span><code>controller</code><span>中直接使用文章开头的方式获取到当前登录用户。</span></p><h2><a name="5-总结" class="md-header-anchor"></a><span>5. 总结</span></h2><p><span>最后再来梳理一遍流程：</span></p><p><span>浏览器发起一个</span><code>Http</code><span>请求到达</span><code>web</code><span>容器，比如</span><code>Tomcat</code><span>，</span><code>Tomcat</code><span>将其封装成一个</span><code>Request</code><span>，先经过</span><code>Filter</code><span>，其中经过</span><code>spring security</code><span>的</span><code>SecurityContextPersistenceFilter</code><span>，从</span><code>session</code><span>中取出</span><code>SecurityContext</code><span>（如果没有就创建新的）存入当前线程的</span><code>ThreadLocalMap</code><span>中，因为是当前线程，所以不同的线程之间根本互不影响。之后完成</span><code>Servlet</code><span>调用，执行</span><code>finally</code><span>语句块，清除当前线程中</span><code>ThreadLocalMap</code><span>对应的</span><code>SecurityContext</code><span>，再将其覆盖</span><code>session</code><span>中之前的部分。</span></p><p><span>这里多说一句，为什么在每次请求之后要清空当前线程呢？看一下</span><code>spring</code><span>的官方</span><code>api</code><span>说明：</span></p><blockquote><p><span>In an application which receives concurrent requests in a single session, the same SecurityContext instance will be shared between threads. Even though a ThreadLocal is being used, it is the same instance that is retrieved from the HttpSession for each thread. This has implications if you wish to temporarily change the context under which a thread is running. If you just use SecurityContextHolder.getContext(), and call setAuthentication(anAuthentication) on the returned context object, then the Authentication object will change in all concurrent threads which share the same SecurityContext instance. You can customize the behaviour of SecurityContextPersistenceFilter to create a completely new SecurityContext for each request, preventing changes in one thread from affecting another. Alternatively you can create a new instance just at the point where you temporarily change the context. The method SecurityContextHolder.createEmptyContext() always returns a new context instance.</span></p></blockquote><p><span>简而言之，因为</span><code>SecurityContext</code><span>是放在</span><code>session</code><span>中的，所有一个</span><code>session</code><span>下的</span><code>request</code><span>都是共享一个</span><code>SecurityContext</code><span>，也就是会有多个</span><code>Thread</code><span>共享一个</span><code>SecurityContext</code><span>。如果我们在某一个线程中只是想临时对</span><code>SecurityContext</code><span>做点更改，那么其他线程中</span><code>SecurityContext</code><span>也会受到影响，这是不被允许的。</span></p><p>&nbsp;</p><p><span>																																						</span><span>Author：</span><a href='https://github.com/NaraLuwan'><span>NaraLuwan</span></a></p><p>&nbsp;</p><p>&nbsp;</p></div>
</body>
</html>